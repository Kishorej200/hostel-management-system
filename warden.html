<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Warden Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1"/>
    <style>
        body {
            margin: 0;
            font-family: Arial, sans-serif;
            background: url("college.jpg") no-repeat center center/cover;
            color: #222;
        }

        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 14px 22px;
            background: rgba(255,255,255,0.85);
            box-shadow: 0 2px 6px rgba(0,0,0,0.1);
        }

        .menu-btn {
            font-size: 26px;
            cursor: pointer;
            padding: 6px 12px;
        }

        .title {
            font-size: 22px;
            font-weight: bold;
        }

        .logo {
            width: 65px;
        }

        .sidebar {
            width: 250px;
            background: #2d2d2d;
            height: 100vh;
            position: fixed;
            left: -260px;
            top: 0;
            padding-top: 60px;
            transition: 0.4s;
            color: white;
            z-index: 999;
        }

        .sidebar a {
            display: block;
            padding: 14px 20px;
            color: white;
            text-decoration: none;
            border-bottom: 1px solid rgba(255,255,255,0.15);
            cursor: pointer;
        }

        .sidebar a:hover {
            background: #444;
        }

        .close-menu {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 26px;
            cursor: pointer;
        }

        .card {
            width: 90%;
            background: rgba(255,255,255,0.75);
            border-radius: 12px;
            padding: 20px;
            margin: 80px auto;
            border: 1px solid #ddd;
            box-shadow: 0 6px 18px rgba(0,0,0,0.12);
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 10px;
            background: white;
        }

        td, th {
            border: 1px solid #777;
            padding: 10px;
            text-align: center;
        }

        .btn {
            padding: 6px 12px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }

        .approve { background: #4caf50; color: white; }
        .reject { background: #f44336; color: white; }

    </style>
</head>
<body>

<div class="topbar">
    <div class="menu-btn" onclick="openMenu()">‚ò∞</div>
    <div class="title">Hostel Management - Warden</div>
    <img src="logo.png" class="logo">
</div>

<div class="sidebar" id="sidebar">
  <!-- ‚úÖ CLICK OUTSIDE AREA -->
<div id="overlay" onclick="closeMenu()" style="
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.3);
    display: none;
    z-index: 998;
"></div>

    <span class="close-menu" onclick="closeMenu()">‚Üê</span>
    <a onclick="loadStudents()">üìã Registered Students</a>
    <a onclick="loadAttendance()">üìÖ Attendance</a>
    <a onclick="loadOutpass()">üèÉ Outpass Requests</a>
    <a onclick="loadLeave()">üìù Leave Forms</a>
    <a onclick="loadComplaints()">üì® Complaints</a>
    <a onclick="loadFeedback()">‚≠ê Feedback</a>
    <a onclick="loadAnnouncements()">üì¢ Announcements</a>
    <a onclick="loadFood()">üçΩ Food Menu</a>
    <a onclick="loadRoomRequests()">üö™ Room Change Requests</a>

    <a onclick="logout()">üö™ Logout</a>
</div>

<div class="card" id="mainContent">
    <h2>Welcome Warden</h2>
    <p>Select an option from the menu.</p>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
import { getFirestore, collection, getDocs, updateDoc, doc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

const firebaseConfig = {
    apiKey: "AIzaSyDeWKD3G8FE5cV36xn9nSIUXVRwbR-0L-w",
    authDomain: "hostelmanagementsystem-151e6.firebaseapp.com",
    projectId: "hostelmanagementsystem-151e6",
    storageBucket: "hostelmanagementsystem-151e6.firebasestorage.app",
    messagingSenderId: "630182817513",
    appId: "1:630182817513:web:42a96594193646bd31ca78"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

onAuthStateChanged(auth, user => {
    if (!user) window.location.href = "index.html";
});

window.openMenu = () => {
    sidebar.style.left = "0px";
};

window.closeMenu = () => {
    sidebar.style.left = "-260px";
};
// Close menu if user clicks outside sidebar
document.addEventListener("click", function (e) {
    // If sidebar is open AND click is not inside sidebar AND not menu button
    if (sidebar.style.left === "0px" && !sidebar.contains(e.target) && e.target.className !== "menu-btn") {
        closeMenu();
    }
});


window.logout = function () {
    if (confirm("Are you sure you want to logout?")) {
        signOut(auth);
        window.location.href = "index.html";
    }
};

// ‚úÖ Load Registered Students from Firebase
window.loadStudents = async function () {
    closeMenu();
    const snap = await getDocs(collection(db, "users"));

    let html = `<h2>Registered Students</h2>
    <table>
    <tr><th>Name</th><th>Reg No</th><th>Dept</th><th>Room</th><th>Email</th></tr>`;

    snap.forEach(d => {
        let s = d.data();
        if (s.role === "student") {
            html += `
            <tr>
                <td>${s.name}</td>
                <td>${s.regno}</td>
                <td>${s.department}</td>
                <td>${s.room}</td>
                <td>${s.email}</td>
            </tr>`;
        }
    });

    html += `</table>`;
    mainContent.innerHTML = html;
};
// ‚úÖ View Attendance + Search + Daily Count Summary + Delete Old Records
window.loadAttendance = async function () {
    closeMenu();
    mainContent.innerHTML = `
        <h2>Attendance Records</h2>

        <input type="text" id="attSearch" placeholder="Search by Name or Register No" class="inp" onkeyup="filterAttendance()">

        <button onclick="showDeletePanel()" style="padding:8px; margin-top:10px; background:red; color:white; border:none; cursor:pointer;">
            Delete Old Records
        </button>

        <div id="deleteBox" style="display:none; margin-top:15px; padding:10px; border:1px solid #aaa;">
            <h3>Delete Records by Date Range</h3>
            <label>From Date:</label><br>
            <input type="date" id="startDate" class="inp"><br><br>

            <label>To Date:</label><br>
            <input type="date" id="endDate" class="inp"><br><br>

            <button onclick="deleteRecordsByDate()" style="padding:8px; background:black; color:white; border:none;">
                Delete Now
            </button>
        </div>

        <div id="summaryBox"><h3>Loading summary...</h3></div>
        <div id="attTable">Loading...</div>
    `;

    const snap = await getDocs(query(collection(db, "attendance"), orderBy("date", "desc")));

    if (snap.empty) {
        document.getElementById("attTable").innerHTML = "<p>No attendance records found.</p>";
        document.getElementById("summaryBox").innerHTML = "";
        return;
    }

    let html = `
    <table id="attendanceTable">
        <tr>
            <th>Name</th>
            <th>Reg No</th>
            <th>Date</th>
            <th>Status</th>
        </tr>`;

    let dailyCount = {};

    snap.forEach(docu => {
        const d = docu.data();
        html += `
        <tr>
            <td>${d.name || ""}</td>
            <td>${d.regno || ""}</td>
            <td>${d.date || ""}</td>
            <td>${d.status || ""}</td>
        </tr>`;

        if (!dailyCount[d.date]) {
            dailyCount[d.date] = { present: 0, absent: 0 };
        }
        if (d.status.toLowerCase() === "present") {
            dailyCount[d.date].present++;
        } else {
            dailyCount[d.date].absent++;
        }
    });

    html += `</table>`;
    document.getElementById("attTable").innerHTML = html;

    let summaryHTML = `
        <h3>Daily Attendance Summary</h3>
        <table>
            <tr>
                <th>Date</th>
                <th>Present</th>
                <th>Absent</th>
            </tr>`;

    Object.keys(dailyCount).forEach(date => {
        summaryHTML += `
            <tr>
                <td>${date}</td>
                <td>${dailyCount[date].present}</td>
                <td>${dailyCount[date].absent}</td>
            </tr>`;
    });

    summaryHTML += `</table>`;
    document.getElementById("summaryBox").innerHTML = summaryHTML;
};


// ‚úÖ Search Filter
window.filterAttendance = function () {
    const searchValue = document.getElementById("attSearch").value.toLowerCase();
    const table = document.getElementById("attendanceTable");
    const rows = table.getElementsByTagName("tr");

    for (let i = 1; i < rows.length; i++) {
        const name = rows[i].cells[0].textContent.toLowerCase();
        const reg = rows[i].cells[1].textContent.toLowerCase();

        rows[i].style.display = (name.includes(searchValue) || reg.includes(searchValue)) ? "" : "none";
    }
};


// ‚úÖ Show delete input box
window.showDeletePanel = function () {
    document.getElementById("deleteBox").style.display = "block";
};


// ‚úÖ Delete Records Between Dates
window.deleteRecordsByDate = async function () {
    let start = document.getElementById("startDate").value;
    let end = document.getElementById("endDate").value;

    if (!start || !end) {
        alert("Select both dates");
        return;
    }

    // Convert to format DD-MM-YYYY
    function convert(d) {
        let x = new Date(d);
        let dd = String(x.getDate()).padStart(2, '0');
        let mm = String(x.getMonth() + 1).padStart(2, '0');
        let yyyy = x.getFullYear();
        return `${dd}-${mm}-${yyyy}`;
    }

    let startDate = convert(start);
    let endDate = convert(end);

    const snap = await getDocs(collection(db, "attendance"));
    let deleted = 0;

    for (const docu of snap.docs) {
        const d = docu.data();
        if (d.date >= startDate && d.date <= endDate) {
            await deleteDoc(doc(db, "attendance", docu.id));
            deleted++;
        }
    }

    alert(`‚úÖ Deleted ${deleted} records between ${startDate} and ${endDate}`);

    loadAttendance(); // refresh table
};


/* ===================== WARDEN - ROOM CHANGE REQUESTS ===================== */
window.loadRoomRequests = async function () {
    mainContent.innerHTML = `<h2>Room Change Requests</h2><p>Loading...</p>`;

    const snap = await getDocs(collection(db, "room_change"));
    if (snap.empty) {
        mainContent.innerHTML = `<h2>Room Change Requests</h2><p>No requests found</p>`;
        return;
    }

    let html = `<h2>Room Change Requests</h2><table>
        <tr><th>Name</th><th>Reg No</th><th>Current</th><th>Requested</th><th>Reason</th><th>Status</th><th>Action</th></tr>`;

    snap.forEach(d => {
        let x = d.data();
        html += `
            <tr>
                <td>${x.name}</td>
                <td>${x.regno}</td>
                <td>${x.currentRoom}</td>
                <td>${x.newRoom}</td>
                <td>${x.reason}</td>
                <td>${x.status}</td>
                <td>
                    <button onclick="approveRoom('${d.id}', '${x.uid}', '${x.newRoom}')">Approve</button>
                    <button onclick="rejectRoom('${d.id}')">Reject</button>
                </td>
            </tr>`;
    });

    html += `</table>`;
    mainContent.innerHTML = html;
};

window.approveRoom = async function (docId, uid, newRoom) {
    const ref = doc(db, "room_change", docId);
    await updateDoc(ref, { status: "Approved" });

    // update student room number
    const userRef = doc(db, "users", uid);
    await updateDoc(userRef, { room: newRoom });

    alert("Room Change Approved ‚úÖ");
    loadRoomRequests();
};

window.rejectRoom = async function (docId) {
    const ref = doc(db, "room_change", docId);
    await updateDoc(ref, { status: "Rejected" });

    alert("Request Rejected ‚ùå");
    loadRoomRequests();
};

// ‚úÖ Load Outpass Requests
window.loadOutpass = async function () {
    closeMenu();
    const snap = await getDocs(collection(db, "outpass"));

    let html = `<h2>Outpass Requests</h2><table>
    <tr>
        <th>Name</th>
        <th>Reason</th>
        <th>Date</th>
        <th>Status</th>
        <th>Action</th>
    </tr>`;

    snap.forEach(d => {
        let info = d.data();

        let statusText = "‚è≥ Pending";
        if (info.status === "Approved") statusText = "‚úÖ Approved";
        if (info.status === "Rejected") statusText = "‚ùå Rejected";

        html += `
        <tr>
            <td>${info.name}</td>
            <td>${info.reason}</td>
            <td>${info.date}</td>
            <td>${statusText}</td>
            <td>
                <button class="btn approve" onclick="approveOutpass('${d.id}')">Approve</button>
                <button class="btn reject" onclick="rejectOutpass('${d.id}')">Reject</button>
                
                <!-- ‚úÖ DELETE BUTTON -->
                <button class="btn delete" onclick="deleteOutpass('${d.id}')">üóë Delete</button>
            </td>
        </tr>`;
    });

    html += `</table>`;
    mainContent.innerHTML = html;
};


// ‚úÖ Approve Outpass
window.approveOutpass = async function (id) {
    await updateDoc(doc(db, "outpass", id), { status: "Approved" });
    alert("‚úÖ Outpass Approved");
    loadOutpass();
};


// ‚úÖ Reject Outpass
window.rejectOutpass = async function (id) {
    await updateDoc(doc(db, "outpass", id), { status: "Rejected" });
    alert("‚ùå Outpass Rejected");
    loadOutpass();
};


// ‚úÖ DELETE Outpass
window.deleteOutpass = async function (id) {
    if (!confirm("Are you sure you want to delete this outpass request?")) return;

    await deleteDoc(doc(db, "outpass", id));
    alert("üóë Outpass Request Deleted");
    loadOutpass();
};



// ---------- additional imports (allowed in same module) ----------
import { addDoc, query, orderBy } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

// ---------- 4. Leave Requests (Approve/Reject + Status + Delete Old Records) ----------
window.loadLeave = async function () {
  closeMenu();
  const snap = await getDocs(collection(db, "leave_requests"));

  let html = `
    <h2>Leave Requests</h2>

    <button onclick="showDeleteLeavePanel()" style="padding:8px; margin-bottom:10px; background:red; color:white; border:none; cursor:pointer;">
      Delete Old Leave Records
    </button>

    <div id="deleteLeaveBox" style="display:none; margin-bottom:15px; padding:10px; border:1px solid #aaa;">
      <h3>Delete Leave Records by Date</h3>
      <label>From Date:</label><br>
      <input type="date" id="leaveStartDate" class="inp"><br><br>

      <label>To Date:</label><br>
      <input type="date" id="leaveEndDate" class="inp"><br><br>

      <button onclick="deleteLeaveRecords()" style="padding:8px; background:black; color:white; border:none; cursor:pointer;">
        Delete Now
      </button>
    </div>

    <table>
      <tr>
        <th>Name</th>
        <th>RegNo</th>
        <th>From</th>
        <th>To</th>
        <th>Reason</th>
        <th>Status</th>
        <th>Action</th>
      </tr>`;

  snap.forEach(d => {
    const it = d.data();

    let status = "Pending ‚è≥";
    if (it.status === "Approved") status = "‚úÖ Approved";
    if (it.status === "Rejected") status = "‚ùå Rejected";

    html += `
      <tr>
        <td>${escapeHtml(it.name || "")}</td>
        <td>${escapeHtml(it.regno || "")}</td>
        <td>${escapeHtml(it.from || "")}</td>
        <td>${escapeHtml(it.to || "")}</td>
        <td>${escapeHtml(it.reason || "")}</td>
        <td>${status}</td>
        <td>
          <button class="btn approve" onclick="approveLeave('${d.id}')">Approve</button>
          <button class="btn reject" onclick="rejectLeave('${d.id}')">Reject</button>
        </td>
      </tr>`;
  });

  html += `</table>`;
  mainContent.innerHTML = html;
};


// ‚úÖ Approve leave
window.approveLeave = async function (id) {
  await updateDoc(doc(db, "leave_requests", id), {
    status: "Approved",
    processedAt: new Date().toISOString()
  });
  alert("‚úÖ Leave Approved");
  loadLeave();
};


// ‚úÖ Reject leave
window.rejectLeave = async function (id) {
  await updateDoc(doc(db, "leave_requests", id), {
    status: "Rejected",
    processedAt: new Date().toISOString()
  });
  alert("‚ùå Leave Rejected");
  loadLeave();
};


// ‚úÖ Show delete panel
window.showDeleteLeavePanel = function () {
  document.getElementById("deleteLeaveBox").style.display = "block";
};


// ‚úÖ Delete leave requests by date range
window.deleteLeaveRecords = async function () {
  let start = document.getElementById("leaveStartDate").value;
  let end = document.getElementById("leaveEndDate").value;

  if (!start || !end) {
    alert("‚ö† Please select both dates");
    return;
  }

  // Convert to DD-MM-YYYY (same as stored)
  function convert(d) {
    let x = new Date(d);
    let dd = String(x.getDate()).padStart(2, '0');
    let mm = String(x.getMonth() + 1).padStart(2, '0');
    let yyyy = x.getFullYear();
    return `${dd}-${mm}-${yyyy}`;
  }

  let startDate = convert(start);
  let endDate = convert(end);

  const snap = await getDocs(collection(db, "leave_requests"));
  let deleted = 0;

  for (const docu of snap.docs) {
    const d = docu.data();
    if (d.from >= startDate && d.from <= endDate) {
      await deleteDoc(doc(db, "leave_requests", docu.id));
      deleted++;
    }
  }

  alert(`‚úÖ Deleted ${deleted} leave records between ${startDate} and ${endDate}`);
  loadLeave();
};
window.loadFeedback = async function () {
  closeMenu();
  const snap = await getDocs(collection(db, "feedback"));

  let html = `<h2>Feedback</h2>`;

  // ‚úÖ Collect dates
  let fbDates = new Set();
  snap.forEach(d => {
    const it = d.data();
    if (it.createdAt) fbDates.add(it.createdAt);
  });

  // ‚úÖ Date dropdown
  if (fbDates.size > 0) {
    html += `
      <label>Delete Feedback on:</label>
      <select id="deleteFBDate">
        ${[...fbDates].map(dt => `<option value="${dt}">${dt}</option>`).join("")}
      </select>
      <button class="btn delete" onclick="deleteFeedbackByDropdown()">üóë Delete</button>
    `;
  }

  html += `<table>
    <tr><th>Name</th><th>RegNo</th><th>Rating</th><th>Message</th><th>Date</th><th>Action</th></tr>`;

  snap.forEach(d => {
    const it = d.data();
    const stars = "‚òÖ".repeat(it.rating || 0) + "‚òÜ".repeat(5 - (it.rating || 0));

    html += `<tr>
      <td>${escapeHtml(it.name || '')}</td>
      <td>${escapeHtml(it.regno || '')}</td>
      <td style="font-size:22px;color:gold">${stars}</td>
      <td style="text-align:left">${escapeHtml(it.message || '')}</td>
      <td>${it.createdAt || "-"}</td>
      <td><button class="btn-icon" onclick="deleteFeedback('${d.id}')">üóë</button></td>
    </tr>`;
  });

  html += `</table>`;
  mainContent.innerHTML = html;
};

window.deleteFeedbackByDropdown = async function () {
  const date = document.getElementById("deleteFBDate").value;

  const q = query(collection(db, "feedback"), where("createdAt", "==", date));
  const snap = await getDocs(q);

  for (let d of snap.docs) {
    await deleteDoc(doc(db, "feedback", d.id));
  }

  alert("‚úÖ Deleted feedback from " + date);
  loadFeedback();
};

window.loadFeedback = async function () {
  closeMenu();
  const snap = await getDocs(collection(db, "feedback"));

  let html = `<h2>Feedback</h2>`;

  // ‚úÖ Collect dates
  let fbDates = new Set();
  snap.forEach(d => {
    const it = d.data();
    if (it.createdAt) fbDates.add(it.createdAt);
  });

  // ‚úÖ Date dropdown
  if (fbDates.size > 0) {
    html += `
      <label>Delete Feedback on:</label>
      <select id="deleteFBDate">
        ${[...fbDates].map(dt => `<option value="${dt}">${dt}</option>`).join("")}
      </select>
      <button class="btn delete" onclick="deleteFeedbackByDropdown()">üóë Delete</button>
    `;
  }

  html += `<table>
    <tr><th>Name</th><th>RegNo</th><th>Rating</th><th>Message</th><th>Date</th><th>Action</th></tr>`;

  snap.forEach(d => {
    const it = d.data();
    const stars = "‚òÖ".repeat(it.rating || 0) + "‚òÜ".repeat(5 - (it.rating || 0));

    html += `<tr>
      <td>${escapeHtml(it.name || '')}</td>
      <td>${escapeHtml(it.regno || '')}</td>
      <td style="font-size:22px;color:gold">${stars}</td>
      <td style="text-align:left">${escapeHtml(it.message || '')}</td>
      <td>${it.createdAt || "-"}</td>
      <td><button class="btn-icon" onclick="deleteFeedback('${d.id}')">üóë</button></td>
    </tr>`;
  });

  html += `</table>`;
  mainContent.innerHTML = html;
};

window.deleteFeedbackByDropdown = async function () {
  const date = document.getElementById("deleteFBDate").value;

  const q = query(collection(db, "feedback"), where("createdAt", "==", date));
  const snap = await getDocs(q);

  for (let d of snap.docs) {
    await deleteDoc(doc(db, "feedback", d.id));
  }

  alert("‚úÖ Deleted feedback from " + date);
  loadFeedback();
};

// ---------- 5. Complaints ----------
window.loadComplaints = async function () {
  closeMenu();
  const snap = await getDocs(collection(db, "complaints"));
  
  let html = `<h2>Complaints</h2>`;

  // ‚úÖ Collect dates (ignore missing date)
  let dates = new Set();
  snap.forEach(d => {
    const it = d.data();
    if (it.createdAt) dates.add(it.createdAt);
  });

  // ‚úÖ Dropdown only if date exists
  if (dates.size > 0) {
    html += `
      <label>Delete Complaints by Date:</label>
      <select id="deleteCompDate">
        ${[...dates].map(dt => `<option value="${dt}">${dt}</option>`).join("")}
      </select>
      <button class="btn delete" onclick="deleteComplaintsByDropdown()">üóë Delete</button>
      <br><br>
    `;
  }

  html += `<table>
    <tr>
      <th>Name</th>
      <th>RegNo</th>
      <th>Message</th>
      <th>Date</th>
      <th>Status</th>
      <th>Action</th>
    </tr>`;
  
  snap.forEach(d => {
    const it = d.data();
    const dateShow = it.createdAt ? it.createdAt : "Unknown Date";

    let status = it.status || "Pending";
    if (status === "Pending") status = "‚è≥ Pending";
    if (status === "Resolved") status = "‚úÖ Resolved";
    if (status === "Closed") status = "‚ùå Closed";

    html += `
    <tr>
      <td>${escapeHtml(it.name || '')}</td>
      <td>${escapeHtml(it.regno || '')}</td>
      <td style="text-align:left">${escapeHtml(it.message || '')}</td>
      <td>${dateShow}</td>
      <td>${status}</td>
      <td>
          <button onclick="resolveComplaint('${d.id}')">‚úÖ</button>
          <button onclick="closeComplaint('${d.id}')">‚ùå</button>
          <button onclick="deleteComplaint('${d.id}')">üóë</button>
      </td>
    </tr>`;
  });

  html += `</table>`;
  mainContent.innerHTML = html;
};

// ‚úÖ Delete 1 complaint
window.deleteComplaint = async function (id) {
  await deleteDoc(doc(db, "complaints", id));
  alert("üóë Complaint Deleted");
  loadComplaints();
};

// ‚úÖ Delete complaints by selected date
window.deleteComplaintsByDropdown = async function () {
  const date = document.getElementById("deleteCompDate").value;
  const q = query(collection(db, "complaints"), where("createdAt", "==", date));
  const snap = await getDocs(q);

  for (let d of snap.docs) {
    await deleteDoc(doc(db, "complaints", d.id));
  }

  alert("‚úÖ Deleted all complaints from: " + date);
  loadComplaints();
};

// ‚úÖ Mark Resolved
window.resolveComplaint = async function (id) {
  await updateDoc(doc(db, "complaints", id), { status: "Resolved" });
  loadComplaints();
};

// ‚úÖ Mark Closed
window.closeComplaint = async function (id) {
  await updateDoc(doc(db, "complaints", id), { status: "Closed" });
  loadComplaints();
};


// ---------- 7. Announcements (Post + Delete) ----------
window.loadAnnouncements = async function () {
  closeMenu();
  const snap = await getDocs(collection(db, "announcements"));
  let html = `<h2>Announcements</h2>
    <div style="margin-bottom:12px">
      <input id="ann_title" placeholder="Title" style="width:60%;padding:8px;margin-right:8px">
      <input id="ann_msg" placeholder="Message" style="width:30%;padding:8px">
      <button class="btn" onclick="postAnnouncement()">Post</button>
    </div>
    <div id="annList">Loading...</div>`;
  mainContent.innerHTML = html;
  await refreshAnnouncements();
};

async function refreshAnnouncements() {
  const el = document.getElementById("annList");
  const snap = await getDocs(collection(db, "announcements"));
  if (snap.empty) {
    el.innerHTML = "<p>No announcements</p>";
    return;
  }
  let html = "";
  snap.forEach(d => {
    const it = d.data();
    html += `<div style="background:#fff;padding:10px;margin:10px 0;border-radius:6px">
      <strong>${escapeHtml(it.title||'')}</strong>
      <p>${escapeHtml(it.message||'')}</p>
      <div style="text-align:right"><button class="btn reject" onclick="deleteAnnouncement('${d.id}')">Delete</button></div>
    </div>`;
  });
  el.innerHTML = html;
}

window.postAnnouncement = async function () {
  const title = document.getElementById("ann_title").value.trim();
  const msg = document.getElementById("ann_msg").value.trim();
  if (!title || !msg) { alert("Title and message required"); return; }
  await addDoc(collection(db, "announcements"), { title, message: msg, createdAt: new Date().toISOString() });
  document.getElementById("ann_title").value = "";
  document.getElementById("ann_msg").value = "";
  refreshAnnouncements();
};

window.deleteAnnouncement = async function (id) {
  if (!confirm("Delete this announcement?")) return;
  await deleteDoc(doc(db, "announcements", id));
  refreshAnnouncements();
};

/* ‚úÖ FOOD MENU (Week + Day Selection) */
window.loadFood = async function () {
  closeMenu();

  mainContent.innerHTML = `
    <h2><b>Food Menu</b></h2>

    <div class="card">
      <label><b>Select Week</b></label>
      <select id="week" style="padding:8px;width:40%;margin:10px 0">
        <option>Week-1</option>
        <option>Week-2</option>
        <option>Week-3</option>
        <option>Week-4</option>
      </select>

      <label><b>Select Day</b></label>
      <select id="day" style="padding:8px;width:40%;margin:10px 0">
        <option>Monday</option>
        <option>Tuesday</option>
        <option>Wednesday</option>
        <option>Thursday</option>
        <option>Friday</option>
        <option>Saturday</option>
        <option>Sunday</option>
      </select>

      <input id="breakfast" placeholder="Breakfast" style="padding:8px;width:60%;margin:5px 0">
      <input id="lunch" placeholder="Lunch" style="padding:8px;width:60%;margin:5px 0">
      <input id="snacks" placeholder="Snacks" style="padding:8px;width:60%;margin:5px 0">
      <input id="dinner" placeholder="Dinner" style="padding:8px;width:60%;margin:5px 0">

      <button class="btn approve" onclick="saveMenu()">Save Menu</button>
    </div>

    <div id="menulist" style="margin-top:25px">Loading menu...</div>
  `;

  await loadMenuTable();
};


/* ‚úÖ SAVE WEEK + DAY MENU */
window.saveMenu = async function () {
  const week = document.getElementById("week").value;
  const day = document.getElementById("day").value;
  const breakfast = document.getElementById("breakfast").value.trim();
  const lunch = document.getElementById("lunch").value.trim();
  const snacks = document.getElementById("snacks").value.trim();
  const dinner = document.getElementById("dinner").value.trim();

  if (!breakfast || !lunch || !snacks || !dinner) {
    alert("Fill all fields!");
    return;
  }

  // ‚úÖ Delete if same week & day exists
  const snap = await getDocs(collection(db, "weekly_menu"));
  for (let d of snap.docs) {
    if (d.data().week === week && d.data().day === day) {
      await deleteDoc(doc(db, "weekly_menu", d.id));
    }
  }

  await addDoc(collection(db, "weekly_menu"), {
    week,
    day,
    breakfast,
    lunch,
    snacks,
    dinner,
    time: Date.now()
  });

  alert("‚úÖ Menu Saved");
  loadMenuTable();
};


/* ‚úÖ LOAD TABLE */
window.loadMenuTable = async function () {
  const area = document.getElementById("menulist");
  const snap = await getDocs(collection(db, "weekly_menu"));

  if (snap.empty) {
    area.innerHTML = "<p>No menu added yet.</p>";
    return;
  }

  let html = `
    <table>
      <tr>
        <th>Week</th>
        <th>Day</th>
        <th>Breakfast</th>
        <th>Lunch</th>
        <th>Snacks</th>
        <th>Dinner</th>
        <th>Action</th>
      </tr>
  `;

  snap.forEach(d => {
    const m = d.data();
    html += `
      <tr>
        <td>${m.week}</td>
        <td>${m.day}</td>
        <td>${m.breakfast}</td>
        <td>${m.lunch}</td>
        <td>${m.snacks}</td>
        <td>${m.dinner}</td>
        <td><button class="btn reject" onclick="deleteMenu('${d.id}')">Delete</button></td>
      </tr>
    `;
  });

  html += `</table>`;
  area.innerHTML = html;
};


/* ‚úÖ DELETE MENU */
window.deleteMenu = async function (id) {
  if (!confirm("Delete this menu?")) return;
  await deleteDoc(doc(db, "weekly_menu", id));
  loadMenuTable();
};


// ---------- Helpers ----------
function escapeHtml(s) {
    if (s === null || s === undefined) return "";
    return String(s).replace(/[&<>"'`=\/]/g, function (c) {
        return {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#39;',
            '/': '&#x2F;',
            '`': '&#96;',
            '=': '&#61;'
        }[c];
    });
}

// ---------- Done: ensure initial state ----------
if (typeof updateSummaryCounts === "function") {
    updateSummaryCounts();
}
</script>
</body>
</html>

